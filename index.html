<!DOCTYPE html>
<html>
<head>
  <title>手勢控制紅色圓形</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
  <script src="https://cdn.jsdelivr.net/npm/ml5@latest/dist/ml5.min.js"></script>
  <style> canvas { position: absolute; top: 0; left: 0; } </style>
</head>
<body>
  <video id="video" width="640" height="480" autoplay muted playsinline style="display:none"></video>
  <canvas id="canvas" width="640" height="480"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let facemesh, predictions = [];
    let handposeModel, handPredictions = [];

    let circleX = 320, circleY = 240; // 預設圓形位置

    // 載入影片串流
    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => { resolve(video); };
      });
    }

    // 初始化
    async function init() {
      await setupCamera();
      video.play();

      facemesh = await ml5.facemesh(video, () => console.log('FaceMesh ready'));
      facemesh.on('predict', results => {
        predictions = results;
      });

      handposeModel = await handpose.load();
      detectHands();
      drawLoop();
    }

    // 持續偵測手勢
    async function detectHands() {
      handPredictions = await handposeModel.estimateHands(video);
      setTimeout(detectHands, 100); // 每0.1秒偵測一次
    }

    // 簡單手勢判斷（示範，只判斷剪刀、拳頭、布）
    function recognizeGesture(hand) {
      if (!hand) return null;

      // 拳頭判斷：所有指尖和指根距離近 (大致都彎曲)
      let curledFingers = 0;
      const tips = [8, 12, 16, 20]; // 四指指尖編號
      for (let tip of tips) {
        const tipPos = hand.annotations.fingerTips ? hand.annotations.fingerTips[tip] : hand.landmarks[tip];
        const dipPos = hand.landmarks[tip - 2];
        const dist = Math.hypot(tipPos[0]-dipPos[0], tipPos[1]-dipPos[1]);
        if (dist < 15) curledFingers++;
      }
      if (curledFingers >= 3) return '拳頭';

      // 布判斷：所有手指伸直（指尖與指根距離遠）
      let extendedFingers = 0;
      for (let tip of tips) {
        const tipPos = hand.landmarks[tip];
        const mcpPos = hand.landmarks[tip - 3];
        const dist = Math.hypot(tipPos[0]-mcpPos[0], tipPos[1]-mcpPos[1]);
        if (dist > 40) extendedFingers++;
      }
      if (extendedFingers >= 4) return '布';

      // 剪刀判斷：食指和中指伸直，其他捲曲
      // 這裡簡化，只判斷食指、中指距離較遠，其他指尖與指根距離小
      const indexTip = hand.landmarks[8];
      const middleTip = hand.landmarks[12];
      const ringTip = hand.landmarks[16];
      const pinkyTip = hand.landmarks[20];
      const ringDip = hand.landmarks[14];
      const pinkyDip = hand.landmarks[18];
      const distIndexMiddle = Math.hypot(indexTip[0] - middleTip[0], indexTip[1] - middleTip[1]);
      const distRing = Math.hypot(ringTip[0] - ringDip[0], ringTip[1] - ringDip[1]);
      const distPinky = Math.hypot(pinkyTip[0] - pinkyDip[0], pinkyTip[1] - pinkyDip[1]);

      if (distIndexMiddle > 30 && distRing < 20 && distPinky < 20) return '剪刀';

      return null;
    }

    // 取得額頭、左臉頰、右臉頰的座標 (用臉部關鍵點，大約位置)
    function getFacePositions() {
      if (!predictions.length) return null;
      const keypoints = predictions[0].scaledMesh;

      return {
        forehead: keypoints[10],       // 額頭點（大致中間上方）
        leftCheek: keypoints[234],    // 左臉頰（臉左側）
        rightCheek: keypoints[454],   // 右臉頰（臉右側）
      };
    }

    function drawLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // 取得手勢
      let gesture = null;
      if (handPredictions.length > 0) {
        gesture = recognizeGesture(handPredictions[0]);
      }

      // 根據手勢改變圓形位置
      const facePos = getFacePositions();
      if (gesture && facePos) {
        if (gesture === '剪刀') {
          circleX = facePos.forehead[0];
          circleY = facePos.forehead[1];
        } else if (gesture === '拳頭') {
          circleX = facePos.leftCheek[0];
          circleY = facePos.leftCheek[1];
        } else if (gesture === '布') {
          circleX = facePos.rightCheek[0];
          circleY = facePos.rightCheek[1];
        }
      }

      // 畫紅色圓形，50x50大小半徑25
      ctx.fillStyle = 'red';
      ctx.beginPath();
      ctx.arc(circleX, circleY, 25, 0, Math.PI * 2);
      ctx.fill();

      requestAnimationFrame(drawLoop);
    }

    init();
  </script>
</body>
</html>
